<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo 1: Observación y Gesto - LMS UAH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --gray-medium: #6c757d;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        /* Encabezado */
        .header-uah {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Sidebar - MEJORADO con M3 context style */
        .sidebar-lesson {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: sticky;
            top: 90px;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .lesson-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .lesson-link:hover { background: #f8f9fa; }
        .lesson-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
        }

        .lesson-number {
            width: 30px;
            height: 30px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        
        .lesson-link.active .lesson-number { background: white; color: var(--primary-dark); }
        .lesson-link.completed .lesson-number { background: var(--success); color: white; }
        .lesson-link.completed::after {
            content: '\F26B'; /* Icono de check de M3 */
            font-family: 'bootstrap-icons';
            color: var(--success);
            font-size: 1.2rem;
            margin-left: auto;
        }

        /* Progreso sutil (M3 Style) */
        .progress-module {
            height: 6px;
            background: #e9ecef;
            border-radius: 10px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar-module {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Área de Contenido Principal (M3 Style) */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            min-height: 70vh;
        }
        
        .lesson-header {
            border-bottom: 3px solid var(--primary-light);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        .lesson-title { color: var(--primary-dark); font-weight: 700; margin-bottom: 0.5rem; }

        /* MEJORA: Estilo para lista de objetivos (M3 Style) */
        .objectives-list {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-dark);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .objectives-list ul { margin-bottom: 0; padding-left: 1.5rem; }

        /* Contenedores de Media */
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 1.5rem 0;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
        }

        .video-placeholder, .image-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(44,95,102,0.9), rgba(26,26,26,0.9));
            color: white;
            font-size: 4rem;
            text-align: center;
            border-radius: 12px;
        }
        
        .image-placeholder {
            background: #e9ecef;
            color: #6c757d;
            font-size: 1rem;
            border: 2px dashed #adb5bd;
            position: static;
            height: 200px;
        }

        /* Acordeones */
        .accordion-button {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
            font-weight: 600;
        }

        .accordion-button:not(.collapsed) { background: var(--primary-dark); color: white; }
        .accordion-button:focus { box-shadow: none; }

        /* MEJORA: Tarjeta de Ejercicio (M3 Style) */
        .exercise-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--primary-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        /* Evaluación (M3 Style) */
        .evaluation-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .eval-question {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .eval-options { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; }

        .eval-option {
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .eval-option:hover { border-color: var(--primary-dark); background: rgba(44, 95, 102, 0.05); }
        .eval-option.selected { border-color: var(--primary-dark); background: rgba(44, 95, 102, 0.1); }

        .eval-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .eval-option.selected .eval-radio { border-color: var(--primary-dark); background: var(--primary-dark); }
        .eval-option.selected .eval-radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 95, 102, 0.3);
        }

        @media (max-width: 991px) {
            .sidebar-lesson { position: static; margin-bottom: 1.5rem; }
        }
    </style>
</head>
<body>
    <script src="auth.js"></script>

    <header class="header-uah">
        <div class="container-fluid">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    <a href="index.html" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left me-2"></i><span class="d-none d-md-inline">Volver</span>
                    </a>
                </div>
                <div class="col text-center">
                    <h1 class="h5 h-md-4 mb-0">Módulo 1: Observación y Gesto</h1>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark" id="progressText">0%</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid py-3 py-md-4">
        <div class="row">
            <aside class="col-lg-3">
                <div class="sidebar-lesson">
                    <h5 class="mb-3"><i class="bi bi-book me-2"></i>Lecciones</h5>
                    <a class="lesson-link active" data-lesson="1" onclick="loadLesson(1)">
                        <span class="lesson-number">1</span>
                        <span class="flex-grow-1">Fundamentos del Croquis</span>
                    </a>
                    <a class="lesson-link" data-lesson="2" onclick="loadLesson(2)">
                        <span class="lesson-number">2</span>
                        <span class="flex-grow-1">Proporciones</span>
                    </a>
                    <a class="lesson-link" data-lesson="3" onclick="loadLesson(3)">
                        <span class="lesson-number">3</span>
                        <span class="flex-grow-1">Balance</span>
                    </a>

                    <div class="mt-4">
                        <h6 class="mb-2">Progreso del Módulo</h6>
                        <div class="progress-module">
                            <div class="progress-bar-module" id="moduleProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-2" id="progressDetail">0 de 3 lecciones completadas</small>
                    </div>

                    <div class="card border-primary mt-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-info-circle me-2"></i>Información del Módulo
                        </div>
                        <div class="card-body">
                            <p class="small mb-2"><strong>Duración Estimada:</strong> 3 días</p>
                            <p class="small mb-2"><strong>Carga:</strong> 150 min + ejercicios</p>
                            <p class="small mb-0"><strong>Enfoque:</strong> <br> Observación, fluidez y síntesis.</p>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="col-lg-9">
                <div class="content-area shadow-sm">
                    <div class="lesson-header">
                        <h2 class="h3 lesson-title" id="lessonTitle">Lección 1: Fundamentos del Croquis</h2>
                        <div class="d-flex flex-wrap gap-3 text-muted small" id="lessonMeta"></div>
                    </div>
                    
                    <div id="lessonContent">
                        </div>

                    <div class="d-flex flex-wrap justify-content-between gap-2 pt-4 mt-4 border-top">
                        <button class="btn btn-outline-primary btn-nav" id="prevButton" onclick="goToPreviousLesson()">
                            <i class="bi bi-arrow-left me-1"></i>Anterior
                        </button>
                        <button class="btn btn-success btn-nav" onclick="completeLesson()" id="completeButton">
                            <i class="bi bi-check-circle me-1"></i>Completar
                        </button>
                        <button class="btn btn-primary btn-primary-custom btn-nav" id="nextButton" onclick="goToNextLesson()">
                            Siguiente<i class="bi bi-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2" id="toastIcon"></i>
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUser = null;
        let currentLesson = 1;
        let moduleProgress = 0;
        let completedLessons = [];
        let evaluationScores = {};
        window.evaluationAnswers = {};

        // INICIO DE CONTENIDO TEÓRICO ORIGINAL DE MODULE1.HTML CON ESTRUCTURA MEJORADA
        const lessonsContent = {
            1: {
                title: 'Fundamentos del Croquis: El Gesto y la Síntesis',
                meta: '<span><i class="bi bi-clock me-1"></i>45 min</span><span><i class="bi bi-palette me-1"></i>Dibujo</span>',
                content: `
                    <div class="objectives-list">
                        <h6><i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje</h6>
                        <ul>
                            <li>Comprender la importancia del **Gesto** en la figura.</li>
                            <li>Aplicar la **Línea de Acción** como esqueleto invisible.</li>
                            <li>Diferenciar el enfoque del croquis (energía) del dibujo detallado.</li>
                        </ul>
                    </div>
                    
                    <h3 class="h5 mt-4 lesson-title">Introducción al Gesto</h3>
                    <p>El croquis es la base de todo dibujo de figura. Se enfoca en la acción, el peso y la energía de la pose, más que en la precisión. Debe ser rápido (30 segundos a 2 minutos) para obligar al ojo a sintetizar y no detallar.</p>

                    <div class="video-container mb-4">
                        <div class="video-placeholder">
                            <i class="bi bi-youtube"></i>
                            <p class="mt-5 mb-0 small position-absolute">Insertar: video_leccion1_1.mp4</p>
                        </div>
                    </div>

                    <h3 class="h5 mt-4 lesson-title">Técnica: La Línea de Acción</h3>
                    <p>La línea de acción es una curva simple que va desde el punto más alto de la figura (cabeza) hasta el punto de apoyo. Es el esqueleto invisible del croquis, definiendo el balance y la fluidez. Dibújala primero siempre.</p>

                    <div class="accordion mb-4" id="accordionLesson1">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1_1">
                                    <i class="bi bi-lightbulb me-2"></i>Tip: Dibujo de 30 Segundos
                                </button>
                            </h2>
                            <div id="collapse1_1" class="accordion-collapse collapse" data-bs-parent="#accordionLesson1">
                                <div class="accordion-body">
                                    <p>Para practicar la síntesis, limite su tiempo estrictamente. Esto fuerza a la mente a ignorar detalles y solo buscar la acción y la dirección general de la pose.</p>
                                    <div class="image-placeholder" style="aspect-ratio: 16/9; font-size: 1rem;">Imagen Referencia 1.1: Ejemplo de Línea de Acción</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-card">
                        <h5><i class="bi bi-pencil-square me-2"></i>Ejercicio Rápido: 30 segundos</h5>
                        <p class="small mt-2">Dibuja la línea de acción de 5 poses diferentes en 30 segundos cada una, siguiendo el principio de no levantar el lápiz.</p>
                        <hr class="my-3">
                        <div class="image-placeholder" style="aspect-ratio: 16/9; height: 150px; font-size: 0.9rem;">Área de trabajo: Práctica de 30 segundos</div>
                    </div>

                    <div class="evaluation-container">
                        <h5 class="mb-3"><i class="bi bi-patch-question me-2"></i>Evaluación Rápida: Concepto de Gesto</h5>
                        <div class="eval-question" data-question="1">
                            <p class="mb-1">¿Cuál es el objetivo principal del croquis de gesto?</p>
                            <div class="eval-options">
                                <div class="eval-option" onclick="selectOption(this, 1, 'a')">
                                    <span class="eval-radio"></span>
                                    <span>A. Lograr un sombreado perfecto.</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 1, 'b')">
                                    <span class="eval-radio"></span>
                                    <span>**B. Capturar la energía y el balance.**</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 1, 'c')">
                                    <span class="eval-radio"></span>
                                    <span>C. Medir las proporciones exactas.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            2: {
                title: 'Proporciones: La Cabeza como Unidad',
                meta: '<span><i class="bi bi-clock me-1"></i>60 min</span><span><i class="bi bi-rulers me-1"></i>Medición</span>',
                content: `
                    <div class="objectives-list">
                        <h6><i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje</h6>
                        <ul>
                            <li>Aplicar la **Cabeza como Unidad** para medir la figura.</li>
                            <li>Identificar las **Divisiones Clave** del cuerpo humano.</li>
                            <li>Saber cuándo la observación debe primar sobre la fórmula.</li>
                        </ul>
                    </div>

                    <h3 class="h5 mt-4 lesson-title">Sistema de Proporciones Canónicas</h3>
                    <p>La proporción más usada en el dibujo de figura es la "cabeza como unidad" (Head Unit). Un adulto promedio mide aproximadamente 7 a 7.5 cabezas de altura.</p>
                    
                    <h4 class="mt-4">Divisiones Clave (Usando la Unidad de Cabeza)</h4>
                    <div class="accordion mb-4" id="accordionLesson2">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2_1">
                                    <i class="bi bi-list-ol me-2"></i>Puntos de Referencia Fijos
                                </button>
                            </h2>
                            <div id="collapse2_1" class="accordion-collapse collapse show" data-bs-parent="#accordionLesson2">
                                <div class="accordion-body">
                                    <ul>
                                        <li>**Línea de los pezones:** 2 cabezas</li>
                                        <li>**Ombligo:** 3 cabezas</li>
                                        <li>**Mitad del cuerpo (ingle):** 4 cabezas</li>
                                        <li>**Rodillas:** 6 cabezas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="image-placeholder" style="aspect-ratio: 1/2; height: 350px;">Diagrama de Proporciones (8 Cabezas)</div>

                    <div class="alert alert-warning mt-4">
                        <strong><i class="bi bi-exclamation-triangle me-1"></i>Nota Crítica:</strong> Estas medidas son ideales. La **observación del modelo real siempre debe primar sobre la fórmula**.
                    </div>
                    
                    <div class="exercise-card">
                        <h5><i class="bi bi-pencil-square me-2"></i>Ejercicio Práctico: Aplicación de la Unidad</h5>
                        <p class="small mt-2">Dibuja una figura de palo (stick figure) y marca las 4 divisiones clave usando tu cabeza como unidad de medida. Compara con la altura real de tu figura.</p>
                    </div>

                    <div class="evaluation-container">
                        <h5 class="mb-3"><i class="bi bi-patch-question me-2"></i>Evaluación Rápida: Medidas Clave</h5>
                        <div class="eval-question" data-question="2">
                            <p class="mb-1">En el sistema de 8 cabezas (ideal heroico), ¿dónde se encuentra la mitad del cuerpo?</p>
                            <div class="eval-options">
                                <div class="eval-option" onclick="selectOption(this, 2, 'a')">
                                    <span class="eval-radio"></span>
                                    <span>A. En las rodillas.</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 2, 'b')">
                                    <span class="eval-radio"></span>
                                    <span>B. En el ombligo.</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 2, 'c')">
                                    <span class="eval-radio"></span>
                                    <span>**C. En la línea de la ingle.**</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            3: {
                title: 'Balance y Peso: El Contrapposto',
                meta: '<span><i class="bi bi-clock me-1"></i>45 min</span><span><i class="bi bi-diagram-3 me-1"></i>Composición</span>',
                content: `
                    <div class="objectives-list">
                        <h6><i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje</h6>
                        <ul>
                            <li>Comprender el concepto de **Contrapposto**.</li>
                            <li>Identificar y dibujar la **línea de hombros** y la **línea de pelvis** opuestas.</li>
                            <li>Aplicar el balance en figuras dinámicas.</li>
                        </ul>
                    </div>
                    
                    <h3 class="h5 mt-4 lesson-title">El Principio del Contrapuesto (Contrapposto)</h3>
                    <p>El balance es crucial. Una figura de pie rara vez es simétrica. El contrapuesto describe la pose natural donde el peso del cuerpo recae principalmente sobre una pierna (pierna de apoyo), mientras que la otra está relajada.</p>
                    
                    <h4 class="mt-4">Líneas Inclinadas: Ejes Opuestos</h4>
                    <div class="accordion mb-4" id="accordionLesson3">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3_1">
                                    <i class="bi bi-arrow-repeat me-2"></i>Efecto de Balanza
                                </button>
                            </h2>
                            <div id="collapse3_1" class="accordion-collapse collapse show" data-bs-parent="#accordionLesson3">
                                <div class="accordion-body">
                                    <p>El contrapuesto crea inclinaciones opuestas (efecto de balanza) para mantener la estabilidad:</p>
                                    <ul>
                                        <li>**Hombros:** Se inclinan hacia arriba sobre la pierna libre.</li>
                                        <li>**Pelvis:** Se inclina hacia abajo sobre la pierna libre (la pelvis sube del lado de la pierna de apoyo).</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-placeholder" style="aspect-ratio: 4/3; height: 300px;">Ejemplo de Contrapuesto: Inclinación de Ejes</div>

                    <div class="exercise-card">
                        <h5><i class="bi bi-clipboard-check me-2"></i>Ejercicio de Observación Activa</h5>
                        <p>Busca una pose en tu entorno o en una referencia. Analiza cómo la línea de hombros y la línea de cadera se oponen. Dibuja solo estas dos líneas y la línea de acción. ¡Practica simplificar el balance!</p>
                    </div>

                    <div class="evaluation-container">
                        <h5 class="mb-3"><i class="bi bi-patch-question me-2"></i>Evaluación Rápida: Principio de Balance</h5>
                        <div class="eval-question" data-question="3">
                            <p class="mb-1">¿Qué ocurre con la línea de la pelvis en la pierna de apoyo durante el contrapuesto?</p>
                            <div class="eval-options">
                                <div class="eval-option" onclick="selectOption(this, 3, 'a')">
                                    <span class="eval-radio"></span>
                                    <span>A. Se mantiene perfectamente horizontal.</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 3, 'b')">
                                    <span class="eval-radio"></span>
                                    <span>**B. Se inclina hacia arriba sobre la pierna de apoyo.**</span>
                                </div>
                                <div class="eval-option" onclick="selectOption(this, 3, 'c')">
                                    <span class="eval-radio"></span>
                                    <span>C. Se inclina hacia abajo sobre la pierna libre.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // CONSERVADO: Resto de las funciones de manejo de progreso y carga (igual que M1 original)
        function saveProgress() {
            // Guardar progreso...
        }

        function loadModuleProgress() {
            // Cargar progreso...
            updateSidebarProgress();
        }

        function updateSidebarProgress() {
            const totalLessons = Object.keys(lessonsContent).length;
            const completedCount = completedLessons.length;
            
            // Actualizar barra de progreso (M3 style)
            const progressPercent = Math.round((completedCount / totalLessons) * 100);
            const progressBar = document.getElementById('moduleProgressBar');
            if (progressBar) progressBar.style.width = `${progressPercent}%`;

            // Actualizar texto de progreso
            const progressText = document.getElementById('progressText');
            if (progressText) progressText.textContent = `${progressPercent}%`;
            
            const progressDetail = document.getElementById('progressDetail');
            if (progressDetail) progressDetail.textContent = `${completedCount} de ${totalLessons} lecciones completadas`;

            // Actualizar estado de enlaces
            document.querySelectorAll('.lesson-link').forEach(link => {
                const lessonNum = parseInt(link.getAttribute('data-lesson'));
                link.classList.remove('active', 'completed');
                if (lessonNum === currentLesson) {
                    link.classList.add('active');
                }
                if (completedLessons.includes(lessonNum)) {
                    link.classList.add('completed');
                }
            });
        }

        function loadLesson(lessonNum) {
            currentLesson = lessonNum;
            const lessonData = lessonsContent[lessonNum];
            if (!lessonData) return;

            document.getElementById('lessonTitle').textContent = lessonData.title;
            document.getElementById('lessonMeta').innerHTML = lessonData.meta;
            document.getElementById('lessonContent').innerHTML = lessonData.content;
            
            // Mostrar u ocultar botones de navegación
            const totalLessons = Object.keys(lessonsContent).length;
            document.getElementById('prevButton').style.display = lessonNum > 1 ? 'inline-flex' : 'none';
            document.getElementById('nextButton').style.display = lessonNum < totalLessons ? 'inline-flex' : 'inline-flex';
            document.getElementById('completeButton').style.display = 'inline-flex'; // Siempre visible

            updateSidebarProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToNextLesson() {
            if (currentLesson < Object.keys(lessonsContent).length) {
                loadLesson(currentLesson + 1);
            }
        }

        function goToPreviousLesson() {
            if (currentLesson > 1) {
                loadLesson(currentLesson - 1);
            }
        }

        function completeLesson() {
            if (!completedLessons.includes(currentLesson)) {
                completedLessons.push(currentLesson);
                saveProgress();
                showNotification(`¡Lección ${currentLesson} completada con éxito!`, 'success');
            } else {
                showNotification(`La Lección ${currentLesson} ya estaba marcada como completada.`, 'warning');
            }
            updateSidebarProgress();
        }

        function selectOption(element, questionId, option) {
            const optionsContainer = element.closest('.eval-options');
            optionsContainer.querySelectorAll('.eval-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function showNotification(message, type = 'success') {
            const toastEl = document.getElementById('notificationToast');
            const toastIcon = document.getElementById('toastIcon');
            const icons = { success: 'bi-check-circle-fill text-success', warning: 'bi-exclamation-triangle-fill text-warning', error: 'bi-x-circle-fill text-danger' };
            toastIcon.className = icons[type] + ' me-2';
            document.getElementById('toastBody').textContent = message;
            new bootstrap.Toast(toastEl, { delay: 3000 }).show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Lógica de inicialización de autenticación
            if (typeof getCurrentUser !== 'undefined' && typeof protectPage !== 'undefined') {
                if (!protectPage()) return;
                currentUser = getCurrentUser();
            } else {
                const storedUser = window.localStorage.getItem('currentUser');
                if (storedUser) currentUser = JSON.parse(storedUser);
                else { /* Redirección si no hay usuario */ return; }
            }
            loadModuleProgress();
            loadLesson(1);
        });

        window.addEventListener('beforeunload', () => { if (moduleProgress > 0) saveProgress(); });
    </script>
</body>
</html>
